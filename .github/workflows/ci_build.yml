#### Build and tests all pushes, also code coverage
name: 🛠️ CI build check
on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev
jobs:
    build:
        name: 🔨 Build sources (CI)
        runs-on: ubuntu-latest
        steps:
            - name: 📤 Checkout the repository 
              uses: actions/checkout@main

            - name: 🥅 Install .Net 5
              uses: actions/setup-dotnet@v1
              with:
                dotnet-version: '5.0.x' # SDK Version

            - name: 🔍 Enable problem matchers
              run: echo "::add-matcher::.github/matchers/dotnet.json"

            - name: 🛠️ Build code
              run: dotnet build

            - name: 👀 Test code
              run: dotnet test -v minimal /p:CollectCoverage=true /p:CoverletOutputFormat=lcov /p:CoverletOutput=${{github.workspace}}/codecover/lcov.info

            - name: 📨 Publish coverage report to coveralls.io
              uses: coverallsapp/github-action@master
              with:
                github-token: ${{ secrets.GITHUB_TOKEN }}
                path-to-lcov: ${{github.workspace}}/codecover/lcov.info

    analyze:
        name: 🔍 Analyze sources (CI)
        runs-on: ubuntu-latest
        steps:
            - name: 📤 Checkout the repository 
              uses: actions/checkout@main
              with:  
                # Shallow clones should be disabled for a better relevancy of analysis
                fetch-depth: 0

            - name: 🔍 Analyze code
              uses: highbyte/sonarscan-dotnet@v2.1-beta
              env:
                SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                sonarOrganization: net-daemon
                sonarProjectKey: net-daemon_netdaemon
                sonarProjectName:  netdaemon
                
                dotnetTestArguments: --logger trx /p:CollectCoverage=true /p:CoverletOutputFormat=opencover
                sonarBeginArguments: >- 
                  /d:sonar.inclusions="**/src/**"
                  /d:sonar.test.inclusions="**/tests/**"
                  /d:sonar.cs.xunit.reportsPaths="**/tests/**/TestResults/*.trx"
                  /d:sonar.cs.opencover.reportsPaths="**/tests/**/coverage.opencover.xml"
